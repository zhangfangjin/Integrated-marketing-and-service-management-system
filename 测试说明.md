# 价格本管理和应收账管理模块 - 测试说明

本文档说明如何运行和验证新增的价格本管理和应收账管理模块的测试。

## 📋 测试类说明

项目已经为新增的两个模块创建了完整的测试类：

### 1. 价格本管理模块测试

**测试类**: `src/test/java/org/example/rootmanage/pricebook/PriceBookControllerTest.java`

**测试覆盖的功能**:
- ✅ 查询价格本列表（带/不带关键词搜索）
- ✅ 根据ID获取价格本详情
- ✅ 根据产品ID获取价格本列表
- ✅ 创建价格本记录
- ✅ 更新价格本记录
- ✅ 删除价格本记录
- ✅ 异常情况处理（记录不存在、验证失败等）

### 2. 应收账管理模块测试

**测试类**: `src/test/java/org/example/rootmanage/receivable/AccountsReceivableControllerTest.java`

**测试覆盖的功能**:
- ✅ 查询应收账计划列表（带/不带关键词搜索）
- ✅ 根据合同编号查询应收账计划
- ✅ 查询应收账列表
- ✅ 查询未付清的应收账
- ✅ 根据ID获取应收账详情
- ✅ 更新应收账信息（应收账录入）
- ✅ 异常情况处理（记录不存在等）

## 🚀 运行测试

### 方式一：运行所有测试

```bash
# 在项目根目录执行
mvn test
```

### 方式二：运行特定模块的测试

```bash
# 仅运行价格本管理模块的测试
mvn test -Dtest=PriceBookControllerTest

# 仅运行应收账管理模块的测试
mvn test -Dtest=AccountsReceivableControllerTest

# 运行两个模块的测试
mvn test -Dtest=PriceBookControllerTest,AccountsReceivableControllerTest
```

### 方式三：运行特定测试方法

```bash
# 运行价格本管理的特定测试方法
mvn test -Dtest=PriceBookControllerTest#testGetPriceBooks_Success

# 运行应收账管理的特定测试方法
mvn test -Dtest=AccountsReceivableControllerTest#testGetPlan_Success
```

### 方式四：使用 IDE 运行

**IntelliJ IDEA**:
1. 打开测试类文件
2. 点击类名或方法名旁边的绿色运行按钮
3. 或右键点击类名/方法名 → Run 'TestName'

**Eclipse**:
1. 打开测试类文件
2. 右键点击类名或方法名
3. 选择 Run As → JUnit Test

## 📊 测试结果说明

### 成功示例

测试通过时，你会看到类似以下的输出：

```
[INFO] Tests run: 10, Failures: 0, Errors: 0, Skipped: 0
[INFO] 
[INFO] ------------------------------------------------------------------------
[INFO] BUILD SUCCESS
[INFO] ------------------------------------------------------------------------
```

### 失败示例

如果测试失败，会显示具体的失败信息：

```
[ERROR] Tests run: 10, Failures: 1, Errors: 0, Skipped: 0
[ERROR] 
[ERROR] Failed tests:
[ERROR]   PriceBookControllerTest.testCreatePriceBook_Success:50 expected: <200> but was: <400>
```

## ✅ 测试验证清单

运行测试后，检查以下内容：

### 价格本管理模块

- [ ] 所有测试用例通过（共 10 个测试方法）
- [ ] GET /api/pricebook - 查询列表正常
- [ ] GET /api/pricebook?keyword=xxx - 关键词搜索正常
- [ ] GET /api/pricebook/{id} - 根据ID查询正常
- [ ] GET /api/pricebook/product/{productId} - 根据产品ID查询正常
- [ ] POST /api/pricebook - 创建价格本正常
- [ ] PUT /api/pricebook/{id} - 更新价格本正常
- [ ] DELETE /api/pricebook/{id} - 删除价格本正常
- [ ] 异常处理正常（记录不存在、验证失败等）

### 应收账管理模块

- [ ] 所有测试用例通过（共 9 个测试方法）
- [ ] GET /api/receivable/plan - 查询应收账计划正常
- [ ] GET /api/receivable/plan?keyword=xxx - 关键词搜索正常
- [ ] GET /api/receivable/plan/contract/{contractNumber} - 根据合同编号查询正常
- [ ] GET /api/receivable - 查询应收账列表正常
- [ ] GET /api/receivable/unpaid - 查询未付清应收账正常
- [ ] GET /api/receivable/{id} - 根据ID查询正常
- [ ] PUT /api/receivable/{id} - 更新应收账正常
- [ ] 异常处理正常（记录不存在等）

## 🔍 测试代码结构说明

测试使用以下技术栈：

- **JUnit 5**: 测试框架
- **Mockito**: Mock 框架（用于模拟 Service 层）
- **Spring MockMvc**: Web 层测试框架
- **@WebMvcTest**: 仅加载 Web 层组件，提高测试速度

### 测试设计模式

测试遵循以下模式：

1. **Given-When-Then** 模式
   ```java
   // Given - 准备测试数据
   when(service.method()).thenReturn(result);
   
   // When - 执行请求
   mockMvc.perform(get("/api/endpoint"))
   
   // Then - 验证结果
   .andExpect(status().isOk())
   .andExpect(jsonPath("$.field").value("expected"));
   ```

2. **Mock 策略**
   - Service 层使用 `@MockBean` 模拟
   - 不依赖数据库，测试速度快
   - 专注于 Controller 层的逻辑测试

## 🛠️ 故障排除

### 问题1: 测试编译失败

**症状**: `mvn test-compile` 失败

**解决方案**:
```bash
# 清理并重新编译
mvn clean test-compile
```

### 问题2: 测试运行失败（Mock 相关）

**症状**: `NullPointerException` 或 Bean 创建失败

**解决方案**:
- 检查测试类中是否所有必需的 `@MockBean` 都已声明
- 确保 `@AutoConfigureMockMvc(addFilters = false)` 已设置

### 问题3: JSON 序列化问题

**症状**: 日期或 BigDecimal 序列化错误

**解决方案**:
- 检查 `ObjectMapper` 配置
- 确保测试数据格式正确

### 问题4: 测试超时

**症状**: 测试运行时间过长

**解决方案**:
- 检查是否有数据库连接（应该使用 Mock，不连接真实数据库）
- 确保使用 `@WebMvcTest` 而不是 `@SpringBootTest`

## 📝 添加新测试用例

如果需要添加新的测试用例，参考现有测试的结构：

```java
@Test
@DisplayName("测试用例描述")
void testMethodName_Scenario() throws Exception {
    // 1. 准备数据（Given）
    when(service.method()).thenReturn(result);
    
    // 2. 执行请求（When）
    mockMvc.perform(get("/api/endpoint")
                    .param("key", "value")
                    .contentType(MediaType.APPLICATION_JSON)
                    .content(jsonContent))
    
    // 3. 验证结果（Then）
            .andExpect(status().isOk())
            .andExpect(jsonPath("$.field").value("expected"));
    
    // 4. 验证服务方法被调用
    verify(service, times(1)).method();
}
```

## 🎯 下一步

测试通过后，你可以：

1. **集成测试**: 运行完整的应用程序，测试真实数据库交互
2. **手动测试**: 使用 Postman 或前端界面测试 API
3. **性能测试**: 测试 API 的性能和并发能力
4. **安全测试**: 测试权限控制和数据验证

---

**祝测试顺利！** 🎉

